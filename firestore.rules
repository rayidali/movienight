/**
 * Core Philosophy: This ruleset enforces a user-ownership model with support for
 * collaborative lists. User-generated content is stored in a private data tree
 * accessible to the owner and optionally to collaborators. The default security
 * posture is to deny all access, granting permissions explicitly.
 *
 * Data Structure:
 * - /users/{userId} - User profiles (public read)
 * - /users/{userId}/lists/{listId} - Movie lists (owner + collaborators can edit)
 * - /users/{userId}/lists/{listId}/movies/{movieId} - Movies in a list
 * - /users/{userId}/followers/{followerId} - Who follows this user
 * - /users/{userId}/following/{followingId} - Who this user follows
 * - /invites/{inviteId} - List collaboration invites
 * - /usernames/{username} - Username reservations
 *
 * Key Security Decisions:
 * - User profiles are publicly readable for search/discovery
 * - Lists can be public (read by anyone) or private (owner + collaborators only)
 * - Collaborators are stored in list.collaboratorIds array
 * - Invites use either direct user ID or shareable invite codes
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the authenticated user is a collaborator on the list.
     * Handles the case where collaboratorIds might not exist.
     */
    function isCollaborator(listData) {
      return isSignedIn() &&
             'collaboratorIds' in listData &&
             request.auth.uid in listData.collaboratorIds;
    }

    /**
     * Safely checks if user is a collaborator, returning false if field doesn't exist.
     */
    function isCollaboratorSafe(listData) {
      return isSignedIn() &&
             listData != null &&
             'collaboratorIds' in listData &&
             listData.collaboratorIds != null &&
             request.auth.uid in listData.collaboratorIds;
    }

    /**
     * Checks if user can view a list (public, owner, or collaborator).
     */
    function canViewList(listData, ownerId) {
      return listData.isPublic == true ||
             isOwner(ownerId) ||
             isCollaborator(listData);
    }

    /**
     * Checks if user can edit a list (owner or collaborator).
     */
    function canEditList(listData, ownerId) {
      return isOwner(ownerId) || isCollaborator(listData);
    }

    // ------------------------------------------------------------------------
    // Users Collection
    // ------------------------------------------------------------------------

    /**
     * @path /users/{userId}
     * User profile documents are publicly readable for search and profile views.
     * Only the user can write to their own profile.
     */
    match /users/{userId} {
      // Allow public read for search, profiles, followers/following display
      allow read: if true;

      // Only owner can create/update/delete their profile
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);

      // ------------------------------------------------------------------------
      // Lists Subcollection
      // ------------------------------------------------------------------------

      /**
       * @path /users/{userId}/lists/{listId}
       * Movie lists. Owner has full control. Public lists can be read by anyone.
       * Collaborators can read the list.
       */
      match /lists/{listId} {
        // Owner can do anything
        allow read, write: if isOwner(userId);

        // Public lists can be read by anyone
        allow read: if resource.data.isPublic == true;

        // Collaborators can read the list
        allow read: if isCollaborator(resource.data);

        // Collaborators cannot modify list metadata (name, visibility, etc.)
        // They can only add/remove movies (see movies subcollection below)

        // ------------------------------------------------------------------------
        // Movies in Lists
        // ------------------------------------------------------------------------

        /**
         * @path /users/{userId}/lists/{listId}/movies/{movieId}
         * Movies within a list. Owner and collaborators can edit.
         * Public lists allow public read.
         */
        match /movies/{movieId} {
          // Get the parent list data for permission checks
          function getListData() {
            return get(/databases/$(database)/documents/users/$(userId)/lists/$(listId)).data;
          }

          // Check if user is a collaborator on the parent list
          function isListCollaborator() {
            let listData = getListData();
            return isSignedIn() &&
                   listData != null &&
                   'collaboratorIds' in listData &&
                   request.auth.uid in listData.collaboratorIds;
          }

          // Check if list is public
          function isListPublic() {
            let listData = getListData();
            return listData != null && listData.isPublic == true;
          }

          // Owner can do anything
          allow read, write: if isOwner(userId);

          // Collaborators can read and write movies
          allow read, write: if isListCollaborator();

          // Public lists allow public read
          allow read: if isListPublic();
        }
      }

      // ------------------------------------------------------------------------
      // Legacy Movies Collection (for backwards compatibility)
      // ------------------------------------------------------------------------

      /**
       * @path /users/{userId}/movies/{movieId}
       * Legacy: Direct movie collection (before lists feature).
       */
      match /movies/{movieId} {
        allow read, write: if isOwner(userId);

        match /socialLinks/{socialLinkId} {
          allow read, write: if isOwner(userId);
        }
      }

      // ------------------------------------------------------------------------
      // Followers/Following
      // ------------------------------------------------------------------------

      /**
       * @path /users/{userId}/followers/{followerId}
       * Who follows this user. The follower creates/deletes their own entry.
       */
      match /followers/{followerId} {
        // Anyone can read followers (for counts, lists)
        allow read: if true;

        // Only the follower can create/delete their follow
        allow create, delete: if isOwner(followerId);

        // No updates - follow is binary
        allow update: if false;
      }

      /**
       * @path /users/{userId}/following/{followingId}
       * Who this user follows. The user manages their own following list.
       */
      match /following/{followingId} {
        // Owner can do anything
        allow read, write: if isOwner(userId);

        // Others can read to check if they're followed
        allow read: if isSignedIn();
      }
    }

    // ------------------------------------------------------------------------
    // Invites Collection
    // ------------------------------------------------------------------------

    /**
     * @path /invites/{inviteId}
     * List collaboration invites. Can be direct (to a user) or link-based (with code).
     */
    match /invites/{inviteId} {
      // Anyone can read an invite (needed for link-based invites)
      allow read: if true;

      // List owner can create invites
      allow create: if isSignedIn() &&
                      request.resource.data.inviterId == request.auth.uid;

      // List owner can update/revoke their invites
      allow update: if isSignedIn() &&
                      resource.data.listOwnerId == request.auth.uid;

      // Invitee can accept/decline their direct invite
      allow update: if isSignedIn() &&
                      resource.data.inviteeId == request.auth.uid &&
                      request.resource.data.status in ['accepted', 'declined'];

      // For link-based invites, any authenticated user can accept
      // (they become the invitee by accepting)
      allow update: if isSignedIn() &&
                      resource.data.inviteCode != null &&
                      resource.data.status == 'pending' &&
                      request.resource.data.status == 'accepted';

      // List owner can delete invites
      allow delete: if isSignedIn() &&
                      resource.data.listOwnerId == request.auth.uid;
    }

    // ------------------------------------------------------------------------
    // Usernames Collection
    // ------------------------------------------------------------------------

    /**
     * @path /usernames/{username}
     * Username reservations to ensure uniqueness.
     */
    match /usernames/{username} {
      // Anyone can read to check availability
      allow read: if true;

      // Only create if uid matches auth
      allow create: if isSignedIn() &&
                      request.resource.data.uid == request.auth.uid;

      // Only owner can delete (to free up username)
      allow delete: if isSignedIn() &&
                      resource.data.uid == request.auth.uid;

      // No updates - to change username, delete and recreate
      allow update: if false;
    }
  }
}
